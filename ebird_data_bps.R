setwd("C:\\Users\\user\\OneDrive\\Documents\\UGA\\Thesis\\NicheModels_2019\\ebird_data_filter\\data")


install.packages('auk')
library(auk)
library(lubridate)
library(sf)
library(gridExtra)
install.packages('lubridate')
install.packages('tidyverse')
library(tidyverse)

ebd_zf<-read.csv("PB_edits.csv",header=T, na.strings=c(""," ","NA"))


#problem: a lot of our records do not have sufficient numbers
#to filter by distance effort/observer/duration

#let's at least filter by effort distance
#and effort duration

#remove nas from duration minutes and effort distance
ebd_zf<-ebd_zf %>% dplyr::filter(!is.na(DURATION.MINUTES), !is.na(EFFORT.DISTANCE.KM))


ebd_zf_filtered <- ebd_zf %>% 
 dplyr:: filter(
    # effort filters
    DURATION.MINUTES <= 5 * 60,
    EFFORT.DISTANCE.KM <= 20)
#hm...should we j

names(ebd_zf)

ebird <- ebd_zf %>% 
 dplyr::select(GLOBAL.UNIQUE.IDENTIFIER,COMMON.NAME,
       SAMPLING.EVENT.IDENTIFIER,OBSERVATION.COUNT,OBSERVER.ID, GROUP.IDENTIFIER,
       LOCALITY.ID,LATITUDE,LONGITUDE,PROTOCOL.TYPE,COUNTY.CODE, TIME.OBSERVATIONS.STARTED)


map_proj <- st_crs(102003)
ne_land <- read_sf("gis-data.gpkg", "ne_land") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()

bcr <- read_sf("gis-data.gpkg", "bcr") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()

ne_country_lines <- read_sf("gis-data.gpkg", "ne_country_lines") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()

ne_state_lines <- read_sf("gis-data.gpkg", "ne_state_lines") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()

ebird<-ebird[!is.na(ebird$LATITUDE), ]
ebird<-ebird[!is.na(ebird$LONGITUDE), ]

ebird_sf <- ebird %>% 
  # convert to spatial points
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326) %>% 
  st_transform(crs = map_proj) %>% 
  select(SAMPLING.EVENT.IDENTIFIER)

coordinates(ebird)<-~ LONGITUDE + LATITUDE
plot(ebird)


library(dggridR)
bb <- st_bbox(c(xmin = -0.1, xmax = 0.1, ymin = -0.1, ymax = 0.1), 
              crs = 4326) %>% 
  st_as_sfc() %>% 
  st_sf()
bb

library(lwgeom)
pts <- st_sample(bb, 500) %>% 
  st_sf(as.data.frame(st_coordinates(.)), geometry = .) %>% 
  rename(lat = Y, lon = X)

##example
dggs <- dgconstruct(spacing = 5)
# for each point, get the grid cell
pts$cell <- dgGEO_to_SEQNUM(dggs, pts$lon, pts$lat)$seqnum

# sample one checklist per grid cell per week
pts_ss <- pts %>% 
  group_by(cell) %>% 
  sample_n(size = 1) %>% 
  ungroup()
#subsample is pts_ss

# generate polygons for the grid cells
hexagons <- dgcellstogrid(dggs, unique(pts$cell), frame = FALSE) %>% 
  st_as_sf()
ggplot() +
  geom_sf(data = hexagons) +
  geom_sf(data = pts, size = 0.5) +
  geom_sf(data = pts_ss, col = "red") +
  theme_bw()








