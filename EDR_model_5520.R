library(spatialEco)
library(AICcmodavg)
library(SDMTools)
library(ROCR)
library(raster)
library(rgdal)
library(lme4)
library(corrplot)
library(ggplot2)
library(dismo)
library(caret)
library(hier.part)

#Eastern Diamondback Rattlesnake

setwd("E:\\FinalModels")
shape<-raster('coastalp_mask')
ex = extent(shape)

setwd('E:\\FinalModels\\Predictors\\EDR\\canopy')
can250<-crop(raster('can250'),ex)
can900<-crop(raster('can900'),ex)

setwd('E:\\FinalModels\\Predictors\\EDR\\drainage')
dran250<-crop(raster('dran250'),ex)
dran900<-crop(raster('dran900'),ex)

setwd('E:\\FinalModels\\Predictors\\EDR\\firefreq')
fire250<-crop(raster('fire250'),ex)
fire900<-crop(raster('fire900'),ex)

setwd('E:\\FinalModels\\Predictors\\EDR\\landcover_old\\distance')
ag_250<-crop(raster('ag_250'),ex)
ag_900<-crop(raster('ag_900'),ex)

#shrub/barren/herb/evergreen mixed forest/mixed forest
setwd('E:\\FinalModels\\Predictors\\EDR\\landcover')
landco250<-crop(raster('landco250'),ex)
landco900<-crop(raster('landco900'),ex)


setwd('E:\\FinalModels\\Predictors\\EDR\\precip')
precip_raw<-crop(raster('precip_raw'),ex)
#precip250<-crop(raster('precip250'),ex)
#precip900<-crop(raster('precip900'),ex)

setwd('E:\\FinalModels\\Predictors\\EDR\\TPI')
tpi_raw<-crop(raster('tpi_raw'),ex)
#tpi250<-crop(raster('tpi250'),ex)
#tpi900<-crop(raster('tpi900'),ex)

setwd('E:\\FinalModels\\Predictors\\EDR\\urbanization')
urb_250<-crop(raster('urb_250'),ex)
urb_900<-crop(raster('urb_900'),ex)
plot(urb_900)
plot(landco250)

####

#new additions 10.14.19
#EVI
setwd('E:\\FinalModels\\Predictors\\EIS\\EVI')
evi250<-crop(raster('evi250'),ex)
evi900<-crop(raster('evi900'),ex)

#longleaf pine 
setwd('E:\\FinalModels\\Predictors\\EDR\\pine_old')
pine250<-crop(raster('pine250'),ex)
pine900<-crop(raster('pine900'),ex)


#urban %
setwd('E:\\FinalModels\\Predictors\\EDR\\urbanization')
urb250<-crop(raster('urb250'),ex)
urb900<-crop(raster('urb900'),ex)

#land disturbance
setwd('E:\\FinalModels\\Predictors\\EIS\\landdist')
hist250<-crop(raster('hist250'),ex)
hist900<-crop(raster('hist900'),ex)

#% ag
setwd('E:\\FinalModels\\Predictors\\EDR\\ag')
ag250<-crop(raster('ag250'),ex)
ag900<-crop(raster('ag900'),ex)


setwd('E:\\FinalModels\\Predictors\\EDR')
EDR<-readOGR(dsn="E:\\FinalModels\\Predictors\\EDR\\edr.finpoints.shp")
points(EDR)
EDR@data$PA[is.na(EDR@data$PA)]<-0

rs<-stack(can250,can900,dran250,dran900,fire250,fire900, ag_250, ag_900, landco250, landco900,precip_raw,tpi_raw,urb_250,urb_900, evi250, evi900,pine250,pine900,urb250,urb900,hist250,hist900, ag250, ag900)
e = data.frame(extract(rs, EDR))
EDR@data = data.frame(EDR@data, e[match(rownames(EDR@data), rownames(e)),])
View(EDR@data)



setwd("C:\\Users\\eliza\\Documents\\UGA\\Thesis\\NicheModels_2019\\EDR")
# df<-as.data.frame(EDR@data)
# df<-na.omit(df)
# write.csv(df, 'EDR.csv')
df<-read.csv('EDR.csv')





#various plotting
library("sm")

#green == 1
#red == 0
#df[,6:21]<-sapply(df[,6:21], as.numeric)
#names(df)
str(df)



loop.vector <- 6:29
for (i in loop.vector) { 
  x <- df[,i]
  sm.density.compare(x,df$PA,xlab=names(df)[i])
}


##can
lr01<- glm(PA ~ can250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ can900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ can250 + I(can250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ can900 + I(can900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#can250 + I(can250^2)

##drain
lr01<- glm(PA ~ dran250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ dran900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ dran250 + I(dran250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ dran900 + I(dran900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#dran250 + I(dran250^2)



##fire
lr01<- glm(PA ~ fire250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ fire900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ fire250 + I(fire250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ fire900 + I(fire900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#fire900


##ag
lr01<- glm(PA ~ ag_250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ ag_900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ ag250, family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ ag900, family=binomial(link="logit"), df, na.action=na.pass)
lr05<- glm(PA ~ ag_250 + I(ag_250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr06<- glm(PA ~ ag_900 + I(ag_900^2), family=binomial(link="logit"), df, na.action=na.pass)
lr07<- glm(PA ~ ag250 + I(ag250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr08<- glm(PA ~ ag900 + I(ag900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, lr05, lr06, lr07, lr08, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","Model5","Model6","Model7", "Model8","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#ag900


##landco
lr01<- glm(PA ~ landco250 + I(fire250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ landco900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ landco250 + I(landco250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ landco900 + I(landco900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#landco250 + I(landco250^2)

##pine
lr01<- glm(PA ~ pine250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ pine900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ pine250 + I(pine250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ pine900 + I(pine900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#pine900 + I(pine900^2)



##urb
lr01<- glm(PA ~ urb_250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ urb_900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ urb250, family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ urb900, family=binomial(link="logit"), df, na.action=na.pass)
lr05<- glm(PA ~ urb_250 + I(urb_250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr06<- glm(PA ~ urb_900 + I(urb_900^2), family=binomial(link="logit"), df, na.action=na.pass)
lr07<- glm(PA ~ urb250 + I(urb250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr08<- glm(PA ~ urb900 + I(urb900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, lr05, lr06, lr07, lr08, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","Model5","Model6","Model7", "Model8","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#urb250 + I(urb250^2)
summary(lr07)


##evi
lr01<- glm(PA ~ evi250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ evi900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ evi250 + I(evi250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ evi900 + I(evi900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#evi250 + I(evi250^2)


##historical disturbance
lr01<- glm(PA ~ hist250, family=binomial(link="logit"), df, na.action=na.pass)
lr02<- glm(PA ~ hist900, family=binomial(link="logit"), df, na.action=na.pass)
lr03<- glm(PA ~ hist250 + I(hist250^2), family=binomial(link="logit"), df, na.action=na.pass)
lr04<- glm(PA ~ hist900 + I(hist900^2), family=binomial(link="logit"), df, na.action=na.pass)
null <- glm(PA ~ 1, df, family = "binomial")
lrModels<- list(lr01, lr02, lr03, lr04, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1", "Model2","Model3","Model4","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#hist900 + I(hist900^2)

#can250 + I(can250^2)
#dran250 + I(dran250^2)
#fire900
#ag900
#landco250 + I(landco250^2)
#pine900 + I(pine900^2)
#urb250 + I(urb250^2) #maybe not that important
#evi250 + I(evi250^2)
#hist900 + I(hist900^2)
#precip raw
#tpi raw



###########################Stage 2
#test predictors for correlations
#test various combinations of predictors
# pred <- df %>% dplyr::select("can900","dran250","fire900","ag900","landco250","pine900","precip_raw","tpi_raw","urb250","evi250","hist900")
# mat<-round(cor(pred[,1:11], method="spearman"), 3)
# mat
# corrplot(mat, method='number')
#hist landuse/ ag

#ag
# lr01<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 + ag900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
# #landuse
# lr02<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  landco250 + I(landco250^2)  + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
# 
# 
# #ag, no urb
# lr03<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 + ag900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              evi250 + I(evi250^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
# #landuse, no urb
# lr04<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
# 
# 
# #ag, no tpi
# lr05<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 + ag900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) + precip_raw , family=binomial(link="logit"), df, na.action=na.pass) 
# #landuse, no tpi
# lr06<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw , family=binomial(link="logit"), df, na.action=na.pass) 
# 
# 
# #ag, quad precip
# lr07<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 + ag900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) + precip_raw + I(precip_raw^2) + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
# #landuse, quad precip
# lr08<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
# 
# 
# #ag, quad precip, quad tpi, no urb
# lr09<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 + ag900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              evi250 + I(evi250^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
# #landuse, quad precip, quad tpi, no urb
# lr10<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
# 
# 
# #ag, quad precip, quad tpi
# lr11<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 + ag900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
# #landuse, quad precip, quad tpi
# lr12<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) +
#              urb250 + I(urb250^2) +  evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
# 
# 
# null <- glm(PA ~ 1, df, family = "binomial")
# 
# lrModels<- list(lr01, lr02, lr03,lr04, lr05, lr06, lr07, lr08,  lr09,lr10, lr11,lr12,null)
# summ<-lapply(lrModels,summary)
# lrNames <- c("Model1","Model2", "Model3", "Model4", "Model5", "Model6", "Model7","Model8", "Model9","Model10","Model11","Model12","null")
# #Calc AICc table
# aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
# #Look at table of aic weights
# aicWt
# 
# lr12<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  landco250 + I(landco250^2) + pine900 + I(pine900^2) + urb250 + I(urb250^2) +  evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
# summary(lr12)

##5/5/2020: let's take a look at 2 things: 90% confidence intervals, and the use of predictors at 

library(dplyr)
pred <- df %>% dplyr::select("can900","dran900","fire900","ag900","landco900","pine900","precip_raw","tpi_raw","urb900","evi900","hist900")
mat<-round(cor(pred[,1:11], method="spearman"), 3)
mat
corrplot(mat, method='number')
#hist/ag

#ag
lr01<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 + ag900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
#landuse
lr02<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2)  + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 


#ag, no urb
lr03<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 + ag900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             evi900 + I(evi900^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
#landuse, no urb
lr04<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 


#ag, no tpi
lr05<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 + ag900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) + precip_raw , family=binomial(link="logit"), df, na.action=na.pass) 
#landuse, no tpi
lr06<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw , family=binomial(link="logit"), df, na.action=na.pass) 


#ag, quad precip
lr07<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 + ag900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) + precip_raw + I(precip_raw^2) + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 
#landuse, quad precip
lr08<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw, family=binomial(link="logit"), df, na.action=na.pass) 


#ag, quad precip, quad tpi, no urb
lr09<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 + ag900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             evi900 + I(evi900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
#landuse, quad precip, quad tpi, no urb
lr10<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 


#ag, quad precip, quad tpi
lr11<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 + ag900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
#landuse, quad precip, quad tpi
lr12<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 


null <- glm(PA ~ 1, df, family = "binomial")

lrModels<- list(lr01, lr02, lr03,lr04, lr05, lr06, lr07, lr08,  lr09,lr10, lr11,lr12,null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model1","Model2", "Model3", "Model4", "Model5", "Model6", "Model7","Model8", "Model9","Model10","Model11","Model12","null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt
#10, then 12; so very little difference in top models



#no urb
lr10<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 


#no can
lr11<- glm(PA ~ dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 

#urb
#landuse, quad precip, quad tpi
lr12<- glm(PA ~ can900 + I(can900^2) + dran900 + I(dran900^2) + fire900 +  landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 

#no fire, can
lr13<- glm(PA ~ dran900 + I(dran900^2) + landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 

#no fire, can, quad dran
lr14<- glm(PA ~ dran900 + landco900 + I(landco900^2) + pine900 + I(pine900^2) +
             urb900 + I(urb900^2) +  evi900 + I(evi900^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 

#very few cov
lr15<- glm(PA ~ dran900 + evi900 + I(evi900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 


null <- glm(PA ~ 1, df, family = "binomial")

lrModels<- list(lr10, lr11, lr12, lr13, lr14, lr15, null)
summ<-lapply(lrModels,summary)
lrNames <- c("Model10","Model11", "Model12", "Model13", "Model14", "Model15", "null")
#Calc AICc table
aicWt<-aictab(cand.set=lrModels, modnames=lrNames, sort=TRUE, c.hat=1)
#Look at table of aic weights
aicWt




#internal validation
opt.cut = function(perf, pred){
  cut.ind = mapply(FUN=function(x, y, p){
    d = (x - 0)^2 + (y-1)^2
    ind = which(d == min(d))
    c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
      cutoff = p[[ind]])
  }, perf@x.values, perf@y.values, pred@cutoffs)
}

iter <- 100         #iterations
K <- 4                #folds
perf.list <- list()
perf <- data.frame(iteration=rep(1:iter,times=K),k=rep(1:K,each=iter),AUC=NA,sens=NA,spec=NA,TSS=NA,cutoff=NA)
for (i in 1:iter){
  folds <- createFolds(df$PA, k = K, list = TRUE, returnTrain = TRUE)
  for (k in 1:K){
    j <- i + iter*(k-1)  #keeps running count to use as index in output dataframe
    pred <- predict(lr12, df[-folds[[k]],], type = "response")
    pred.lab <- as.data.frame(cbind(pred,df$PA[-folds[[k]]]))
    colnames(pred.lab) <- c("predictions","labels")
    pred.lab1 <- prediction(pred.lab$predictions,pred.lab$labels) 
    perf.auc <- performance(prediction(pred, df$PA[-folds[[k]]]),"auc")
    perf.roc <- performance(pred.lab1, measure = "tpr", x.measure = "fpr")
    perf.sens <- performance(prediction(pred,df$PA[-folds[[k]]]), "sens","spec")
    cutoff <- opt.cut(perf.roc, pred.lab1)
    perf$AUC[j] <- perf.auc@y.values[[1]] # AUC
    perf$sens[j] <- cutoff["sensitivity",] # sensitivity
    perf$spec[j] <- cutoff["specificity",] # specificity
    perf$cutoff[j] <- cutoff["cutoff",] # optimal cutoff
    perf$TSS[j] <- perf$sens[j] + perf$spec[j] - 1
  }
}

plot(density(perf$cutoff))
abline(v=mean(perf$cutoff),lty=2,lwd=2,col="red")
opt.cutoff <- mean(perf$cutoff) 
auc.mean<-mean(perf$AUC)
auc.mean
plot(density(perf$AUC))
#.83


lr12<- glm(PA ~ can250 + I(can250^2) + dran250 + I(dran250^2) + fire900 +  
             landco250 + I(landco250^2) + pine900 + I(pine900^2) + urb250 + I(urb250^2) + 
             evi250 + I(evi250^2) +  hist900 + I(hist900^2) + precip_raw + I(precip_raw^2) + tpi_raw + I(tpi_raw^2), family=binomial(link="logit"), df, na.action=na.pass) 
summary(lr12)
rs<-stack(can250,dran250,fire900,landco250,pine900, urb250, evi250, hist900,precip_raw,tpi_raw,urb_250)
EDR_pred <- predict(rs, lr12, type="response", progress='text', na.action = na.omit, overwrite=T)
plot(EDR_pred)

setwd("E:\\FinalModels\\Predictors\\EDR")
writeRaster(EDR_pred,'EDR_prednew',format='GTiff', overwrite=T)

# df$canquad<-I(df$can250^2)
# df$dranquad<-I(df$dran250^2)
# df$landcoquad<-I(df$landco250^2)
# df$pinequad<-I(df$pine900^2)
# df$urbquad<-I(df$urb250^2)
# df$eviquad<-I(df$evi250^2)
# df$histquad<-I(df$hist900^2)
# df$precipquad<-I(df$precip_raw^2)
# df$tpiquad<-I(df$tpi_raw^2)
names(df)
pred <- df %>% dplyr::select("can250","dran250","fire900","landco250","pine900", "urb250", "evi250", "hist900","precip_raw","tpi_raw")

pred.importance <- hier.part(df$PA, pred, fam = "binomial", gof = c("logLik"))
pred.Imp <- data.frame(Variance=pred.importance$I.perc)
colnames(pred.Imp)[1] <- "Expl_variance"
pred.Imp <- pred.Imp[order(-pred.Imp$Expl_variance), , drop = FALSE]
setwd("E:\\FinalModels\\Predictors\\EDR")
write.csv(pred.Imp, 'PredictorImportanceEDR.csv')
